
----------------------------------------------------------------------------------------
--------------------------- MARCA BOF V2 - MARCA DE "AMENAZA" --------------------------
----------------------------------------------------------------------------------------

-- Doc Base: https://docs.google.com/presentation/d/1uf2fiSl0yrifrLOO1CFnfcVlmx43AdqwLfI1C-pahOQ/edit#slide=id.g1045e6e6e7c_0_655

-- sellers que publicaram muitos electronics
drop table if exists `meli-bi-data.SBOX_PF_MKT.lista_inicial0`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.lista_inicial0`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    sit_site_id site_id,
    cus_cust_id_sel cust_id,
    cast(cus_ru_fixed_sel as date) fecha_regi,
    sum(gmv_usd) gmv_total
  from `meli-bi-data.SBOX_PF_MKT.fraud_main`
  where cast(cus_ru_fixed_sel as date) <= current_date - interval '6' month
    and tim_day_winning_date > current_date - interval '6' month
    and sit_site_id in ('MLB   ','MLA   ','MLM   ','MLC   ','MCO   ')
  group by 1,2,3
  having gmv_total > 20000;


-- lista complementar com pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.lista_inicial`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.lista_inicial`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    b.site_id,
    b.cust_id,
    b.fecha_regi,
    sum(a.ite_item_quantity_total * a.ite_item_base_price) pxq_total,
    b.gmv_total
  from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a
  left join `meli-bi-data.SBOX_PF_MKT.lista_inicial0` b
    on a.cus_cust_id_sel = b.cust_id
  where cast(a.ite_item_auction_start_datetime as date) > current_date - interval '6' month
  group by 1,2,3,5
  having pxq_total > 100000;



--------------------------- EVOLUÇÕES SEMANAIS ---------------------------

-- evolução semanal pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.pxq_semanal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.pxq_semanal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    li.site_id,
    li.cust_id,
    coalesce(a.pxq,0) pxq_s1,
    coalesce(b.pxq,0) pxq_s2,
    coalesce(c.pxq,0) pxq_s3,
    coalesce(d.pxq,0) pxq_s4,
    coalesce(e.pxq,0) pxq_s5,
    coalesce(f.pxq,0) pxq_s6,
    coalesce(g.pxq,0) pxq_s7,
    coalesce(h.pxq,0) pxq_s8
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 7 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 14 and current_date - 8 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 21 and current_date - 15 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 28 and current_date - 22 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 35 and current_date - 29 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 42 and current_date - 36 group by 1) f 
    ON li.cust_id = f.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 49 and current_date - 43 group by 1) g
    ON li.cust_id = g.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 56 and current_date - 50 group by 1) h
    ON li.cust_id = h.cust_id
  WHERE a.pxq > 20000;


-- evolução semanal asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.asp_semanal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.asp_semanal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.asp,0) asp_s1,
    coalesce(b.asp,0) asp_s2,
    coalesce(c.asp,0) asp_s3,
    coalesce(d.asp,0) asp_s4,
    coalesce(e.asp,0) asp_s5,
    coalesce(f.asp,0) asp_s6,
    coalesce(g.asp,0) asp_s7,
    coalesce(h.asp,0) asp_s8
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 7 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 14 and current_date - 8 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 21 and current_date - 15 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 28 and current_date - 22 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 35 and current_date - 29 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 42 and current_date - 36 group by 1) f 
    ON li.cust_id = f.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 49 and current_date - 43 group by 1) g
    ON li.cust_id = g.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 56 and current_date - 50 group by 1) h
    ON li.cust_id = h.cust_id
  WHERE a.asp > 100;


-- evolução semanal gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.gmv_semanal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.gmv_semanal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.gmv,0) gmv_s1,
    coalesce(b.gmv,0) gmv_s2,
    coalesce(c.gmv,0) gmv_s3,
    coalesce(d.gmv,0) gmv_s4,
    coalesce(e.gmv,0) gmv_s5,
    coalesce(f.gmv,0) gmv_s6,
    coalesce(g.gmv,0) gmv_s7,
    coalesce(h.gmv,0) gmv_s8
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 7 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 14 and current_date - 8 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 21 and current_date - 15 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 28 and current_date - 22 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 35 and current_date - 29 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 42 and current_date - 36 group by 1) f 
    ON li.cust_id = f.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 49 and current_date - 43 group by 1) g
    ON li.cust_id = g.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 56 and current_date - 50 group by 1) h
    ON li.cust_id = h.cust_id
  WHERE a.gmv > 10000;


-- evolução semanal parcela de hotnew
drop table if exists `meli-bi-data.SBOX_PF_MKT.parcela_hn_semanal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.parcela_hn_semanal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.parcela_hn,0) parcela_hn_s1,
    coalesce(b.parcela_hn,0) parcela_hn_s2,
    coalesce(c.parcela_hn,0) parcela_hn_s3,
    coalesce(d.parcela_hn,0) parcela_hn_s4,
    coalesce(e.parcela_hn,0) parcela_hn_s5,
    coalesce(f.parcela_hn,0) parcela_hn_s6,
    coalesce(g.parcela_hn,0) parcela_hn_s7,
    coalesce(h.parcela_hn,0) parcela_hn_s8
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 7 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 14 and current_date - 8 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 21 and current_date - 15 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATOR','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 28 and current_date - 22 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 35 and current_date - 29 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 42 and current_date - 36 group by 1) f
    ON li.cust_id = f.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 49 and current_date - 43 group by 1) g
    ON li.cust_id = g.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 56 and current_date - 50 group by 1) h
    ON li.cust_id = h.cust_id;


-- evolução semanal uso de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.adto_semanal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.adto_semanal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT distinct
    li.site_id,
    li.cust_id,
    coalesce(a.adto,0) adto_s1,
    coalesce(b.adto,0) adto_s2,
    coalesce(c.adto,0) adto_s3,
    coalesce(d.adto,0) adto_s4,
    coalesce(e.adto,0) adto_s5,
    coalesce(f.adto,0) adto_s6,
    coalesce(g.adto,0) adto_s7,
    coalesce(h.adto,0) adto_s8
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 7 and current_date then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 14 and current_date - 8 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 21 and current_date - 15 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 28 and current_date - 22 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 35 and current_date - 29 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 42 and current_date - 36 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) f
    ON li.cust_id = f.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 49 and current_date - 43 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) g
    ON li.cust_id = g.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 56 and current_date - 50 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) h
    ON li.cust_id = h.cust_id;



------------------------- RATIOS - SEMANA X SEMANA -------------------------

-- ratios de pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_pxq1`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_pxq1`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when pxq_s2 = 0 and pxq_s1 = 0 then 0
      when pxq_s2 = 0 and pxq_s1 > 0 then 1000
      else round(cast(pxq_s1 as numeric)/nullif(cast(pxq_s2 as numeric),0),2)
    end) ratio_pxq_s1,
    (case
      when pxq_s3 = 0 and pxq_s2 = 0 then 0
      when pxq_s3 = 0 and pxq_s2 > 0 then 1000
      else round(cast(pxq_s2 as numeric)/nullif(cast(pxq_s3 as numeric),0),2)
    end) ratio_pxq_s2,
    (case
      when pxq_s4 = 0 and pxq_s3 = 0 then 0
      when pxq_s4 = 0 and pxq_s3 > 0 then 1000
      else round(cast(pxq_s3 as numeric)/nullif(cast(pxq_s4 as numeric),0),2)
    end) ratio_pxq_s3
  from `meli-bi-data.SBOX_PF_MKT.pxq_semanal`;


-- ratios de asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_asp1`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_asp1`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when asp_s2 = 0 and asp_s1 = 0 then 0
      when asp_s2 = 0 and asp_s1 > 0 then 1000
      else round(cast(asp_s1 as numeric)/nullif(cast(asp_s2 as numeric),0),2)
    end) ratio_asp_s1,
    (case
      when asp_s3 = 0 and asp_s2 = 0 then 0
      when asp_s3 = 0 and asp_s2 > 0 then 1000
      else round(cast(asp_s2 as numeric)/nullif(cast(asp_s3 as numeric),0),2)
    end) ratio_asp_s2,
    (case
      when asp_s4 = 0 and asp_s3 = 0 then 0
      when asp_s4 = 0 and asp_s3 > 0 then 1000
      else round(cast(asp_s3 as numeric)/nullif(cast(asp_s4 as numeric),0),2)
    end) ratio_asp_s3
  from `meli-bi-data.SBOX_PF_MKT.asp_semanal`;


-- ratios de gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_gmv1`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_gmv1`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when gmv_s2 = 0 and gmv_s1 = 0 then 0
      when gmv_s2 = 0 and gmv_s1 > 0 then 1000
      else round(cast(gmv_s1 as numeric)/nullif(cast(gmv_s2 as numeric),0),2)
    end) ratio_gmv_s1,
    (case
      when gmv_s3 = 0 and gmv_s2 = 0 then 0
      when gmv_s3 = 0 and gmv_s2 > 0 then 1000
      else round(cast(gmv_s2 as numeric)/nullif(cast(gmv_s3 as numeric),0),2)
    end) ratio_gmv_s2,
    (case
      when gmv_s4 = 0 and gmv_s3 = 0 then 0
      when gmv_s4 = 0 and gmv_s3 > 0 then 1000
      else round(cast(gmv_s3 as numeric)/nullif(cast(gmv_s4 as numeric),0),2)
    end) ratio_gmv_s3
  from `meli-bi-data.SBOX_PF_MKT.gmv_semanal`;


-- ratios de parcela consumer electronics
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn1`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn1`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when parcela_hn_s2 = 0 and parcela_hn_s1 = 0 then 0
      when parcela_hn_s2 = 0 and parcela_hn_s1 > 0 then 1000
      else round(cast(parcela_hn_s1 as numeric)/nullif(cast(parcela_hn_s2 as numeric),0),2)
    end) ratio_hn_s1,
    (case
      when parcela_hn_s3 = 0 and parcela_hn_s2 = 0 then 0
      when parcela_hn_s3 = 0 and parcela_hn_s2 > 0 then 1000
      else round(cast(parcela_hn_s2 as numeric)/nullif(cast(parcela_hn_s3 as numeric),0),2)
    end) ratio_hn_s2,
    (case
      when parcela_hn_s4 = 0 and parcela_hn_s3 = 0 then 0
      when parcela_hn_s4 = 0 and parcela_hn_s3 > 0 then 1000
      else round(cast(parcela_hn_s3 as numeric)/nullif(cast(parcela_hn_s4 as numeric),0),2)
    end) ratio_hn_s3
  from `meli-bi-data.SBOX_PF_MKT.parcela_hn_semanal`;


-- ratios de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_adto1`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_adto1`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when adto_s2 = 0 and adto_s1 = 0 then 0
      when adto_s2 = 0 and adto_s1 > 0 then 1000
      else round(cast(adto_s1 as numeric)/nullif(cast(adto_s2 as numeric),0),2)
    end) ratio_adto_s1,
    (case
      when adto_s3 = 0 and adto_s2 = 0 then 0
      when adto_s3 = 0 and adto_s2 > 0 then 1000
      else round(cast(adto_s2 as numeric)/nullif(cast(adto_s3 as numeric),0),2)
    end) ratio_adto_s2,
    (case
      when adto_s4 = 0 and adto_s3 = 0 then 0
      when adto_s4 = 0 and adto_s3 > 0 then 1000
      else round(cast(adto_s3 as numeric)/nullif(cast(adto_s4 as numeric),0),2)
    end) ratio_adto_s3
  from `meli-bi-data.SBOX_PF_MKT.adto_semanal`;



------------------------- RATIOS - SEMANA1 X SEMANAs -------------------------

-- ratios de pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_pxq2`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_pxq2`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    pxq_s1 semana_atual,
    (pxq_s2 + pxq_s3 + pxq_s4 + pxq_s5 + pxq_s6 + pxq_s7 + pxq_s8) ultimas_semanas,
    (case
      when pxq_s1 > 0 and pxq_s2 + pxq_s3 + pxq_s4 + pxq_s5 + pxq_s6 + pxq_s7 + pxq_s8 = 0 then 1000
      else round(cast(pxq_s1 as numeric)/nullif(cast((pxq_s2 + pxq_s3 + pxq_s4 + pxq_s5 + pxq_s6 + pxq_s7 + pxq_s8)/7 as numeric),0),2)
    end) ratio_pxq_sxss
  from `meli-bi-data.SBOX_PF_MKT.pxq_semanal`;


-- ratios de asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_asp2`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_asp2`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    asp_s1 semana_atual,
    (asp_s2 + asp_s3 + asp_s4 + asp_s5 + asp_s6 + asp_s7 + asp_s8) ultimas_semanas,
    (case
      when asp_s1 > 0 and asp_s2 + asp_s3 + asp_s4 + asp_s5 + asp_s6 + asp_s7 + asp_s8 = 0 then 1000
      else round(cast(asp_s1 as numeric)/nullif(cast((asp_s2 + asp_s3 + asp_s4 + asp_s5 + asp_s6 + asp_s7 + asp_s8)/7 as numeric),0),2)
    end) ratio_asp_sxss
  from `meli-bi-data.SBOX_PF_MKT.asp_semanal`;


-- ratios de gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_gmv2`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_gmv2`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    gmv_s1 semana_atual,
    (gmv_s2 + gmv_s3 + gmv_s4 + gmv_s5 + gmv_s6 + gmv_s7 + gmv_s8) ultimas_semanas,
    (case
      when gmv_s1 > 0 and gmv_s2 + gmv_s3 + gmv_s4 + gmv_s5 + gmv_s6 + gmv_s7 + gmv_s8 = 0 then 1000
      else round(cast(gmv_s1 as numeric)/nullif(cast((gmv_s2 + gmv_s3 + gmv_s4 + gmv_s5 + gmv_s6 + gmv_s7 + gmv_s8)/7 as numeric),0),2)
    end) ratio_gmv_sxss
  from `meli-bi-data.SBOX_PF_MKT.gmv_semanal`;


-- ratios de parcela consumer electronics
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn2`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn2`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    parcela_hn_s1 semana_atual,
    (parcela_hn_s2 + parcela_hn_s3 + parcela_hn_s4 + parcela_hn_s5 + parcela_hn_s6 + parcela_hn_s7 + parcela_hn_s8) ultimas_semanas,
    (case
      when parcela_hn_s1 > 0 and parcela_hn_s2 + parcela_hn_s3 + parcela_hn_s4 + parcela_hn_s5 + parcela_hn_s6 + parcela_hn_s7 + parcela_hn_s8 = 0 then 1000
      else round(cast(parcela_hn_s1 as numeric)/nullif(cast((parcela_hn_s2 + parcela_hn_s3 + parcela_hn_s4 + parcela_hn_s5 + parcela_hn_s6 + parcela_hn_s7 + parcela_hn_s8)/7 as numeric),0),2)
    end) ratio_parcela_hn_sxss
  from `meli-bi-data.SBOX_PF_MKT.parcela_hn_semanal`;


-- ratios de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_adto2`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_adto2`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    adto_s1 semana_atual,
    (adto_s2 + adto_s3 + adto_s4 + adto_s5 + adto_s6 + adto_s7 + adto_s8) ultimas_semanas,
    (case
      when adto_s1 > 0 and adto_s2 + adto_s3 + adto_s4 + adto_s5 + adto_s6 + adto_s7 + adto_s8 = 0 then 1000
      else round(cast(adto_s1 as numeric)/nullif(cast((adto_s2 + adto_s3 + adto_s4 + adto_s5 + adto_s6 + adto_s7 + adto_s8)/7 as numeric),0),2)
    end) ratio_adto_sxss
  from `meli-bi-data.SBOX_PF_MKT.adto_semanal`
  where adto_s1 > 1000;



--------------------------- EVOLUÇÕES MENSAIS ---------------------------

-- evolução semanal pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.pxq_mensal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.pxq_mensal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    li.site_id,
    li.cust_id,
    coalesce(a.pxq,0) pxq_m1,
    coalesce(b.pxq,0) pxq_m2,
    coalesce(c.pxq,0) pxq_m3,
    coalesce(d.pxq,0) pxq_m4,
    coalesce(e.pxq,0) pxq_m5,
    coalesce(f.pxq,0) pxq_m6
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 30 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 60 and current_date - 31 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 90 and current_date - 61 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 120 and current_date - 91 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 150 and current_date - 121 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(ite_item_quantity_total * ite_item_base_price) pxq
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 180 and current_date - 151 group by 1) f 
    ON li.cust_id = f.cust_id
  WHERE a.pxq > 40000;


-- evolução semanal asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.asp_mensal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.asp_mensal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.asp,0) asp_m1,
    coalesce(b.asp,0) asp_m2,
    coalesce(c.asp,0) asp_m3,
    coalesce(d.asp,0) asp_m4,
    coalesce(e.asp,0) asp_m5,
    coalesce(f.asp,0) asp_m6
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 30 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 60 and current_date - 31 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 90 and current_date - 61 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 120 and current_date - 91 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 150 and current_date - 121 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      avg(ite_item_base_price) asp
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS`
    where cast(ite_item_auction_start_datetime as date) between current_date - 180 and current_date - 151 group by 1) f 
    ON li.cust_id = f.cust_id;


-- evolução semanal gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.gmv_mensal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.gmv_mensal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.gmv,0) gmv_m1,
    coalesce(b.gmv,0) gmv_m2,
    coalesce(c.gmv,0) gmv_m3,
    coalesce(d.gmv,0) gmv_m4,
    coalesce(e.gmv,0) gmv_m5,
    coalesce(f.gmv,0) gmv_m6
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 30 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 60 and current_date - 31 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 90 and current_date - 61 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 120 and current_date - 91 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 150 and current_date - 121 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      cus_cust_id_sel cust_id,
      sum(gmv_usd) gmv
    from `meli-bi-data.SBOX_PF_MKT.fraud_main`
    where tim_day_winning_date between current_date - 180 and current_date - 151 group by 1) f 
    ON li.cust_id = f.cust_id
  WHERE a.gmv > 15000;


-- evolução semanal parcela de hotnew
drop table if exists `meli-bi-data.SBOX_PF_MKT.parcela_hn_mensal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.parcela_hn_mensal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT
    li.site_id,
    li.cust_id,
    coalesce(a.parcela_hn,0) parcela_hn_m1,
    coalesce(b.parcela_hn,0) parcela_hn_m2,
    coalesce(c.parcela_hn,0) parcela_hn_m3,
    coalesce(d.parcela_hn,0) parcela_hn_m4,
    coalesce(e.parcela_hn,0) parcela_hn_m5,
    coalesce(f.parcela_hn,0) parcela_hn_m6
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 30 and current_date group by 1) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 60 and current_date - 31 group by 1) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 90 and current_date - 61 group by 1) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATOR','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 120 and current_date - 91 group by 1) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 150 and current_date - 121 group by 1) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (select
      a.cus_cust_id_sel cust_id,
      round(cast(sum(case when b.dom_domain_agg3 in ('NOTEBOOKS','AIR CONDITIONERS','CONSOLES','GAMES','FREEZERS', 'REFRIGERATORS','CAMERA',
      'TELEPHONY ACCESSORIES','DRONE','TV','VIDEO GAMES','CELLPHONES', 'MOBILE ACCESSORIES','SMARTWATCHES','TABLET','HEADSET','TELEPHONES')
      then 1 else 0 end) as numeric)/nullif(cast(count(a.ite_item_id) as numeric),0),2) parcela_hn
    from `meli-bi-data.EXPLOTACION.LK_ITE_ITEMS` a left join `meli-bi-data.WHOWNER.LK_DOM_DOMAINS` b on a.ite_item_dom_domain_id = b.dom_domain_id
    where cast(ite_item_auction_start_datetime as date) between current_date - 180 and current_date - 151 group by 1) f
    ON li.cust_id = f.cust_id;


-- evolução semanal uso de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.adto_mensal`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.adto_mensal`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  SELECT distinct
    li.site_id,
    li.cust_id,
    coalesce(a.adto,0) adto_m1,
    coalesce(b.adto,0) adto_m2,
    coalesce(c.adto,0) adto_m3,
    coalesce(d.adto,0) adto_m4,
    coalesce(e.adto,0) adto_m5,
    coalesce(f.adto,0) adto_m6
  FROM `meli-bi-data.SBOX_PF_MKT.lista_inicial` li
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 30 and current_date then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) a
    ON li.cust_id = a.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 60 and current_date - 31 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) b
    ON li.cust_id = b.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 90 and current_date - 61 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) c
    ON li.cust_id = c.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 120 and current_date - 91 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) d
    ON li.cust_id = d.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 150 and current_date - 121 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) e
    ON li.cust_id = e.cust_id
  LEFT JOIN
    (
    select
      cus_cust_id cust_id,
      sum(case when creation_date between current_date - 180 and current_date - 151 then total_inusd else 0 end) adto
    from `meli-bi-data.WHOWNER.BT_MP_MIA`
    where status = 'DONE'
    group by 1
    ) f
    ON li.cust_id = f.cust_id;



------------------------- RATIOS - MES1 X MES2 -------------------------

-- ratios de pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_pxq3`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_pxq3`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when pxq_m2 = 0 and pxq_m1 = 0 then 0
      when pxq_m2 = 0 and pxq_m1 > 0 then 1000
      else round(cast(pxq_m1 as numeric)/nullif(cast(pxq_m2 as numeric),0),2)
    end) ratio_pxq_m1,
    (case
      when pxq_m3 = 0 and pxq_m2 = 0 then 0
      when pxq_m3 = 0 and pxq_m2 > 0 then 1000
      else round(cast(pxq_m2 as numeric)/nullif(cast(pxq_m3 as numeric),0),2)
    end) ratio_pxq_m2,
    (case
      when pxq_m4 = 0 and pxq_m3 = 0 then 0
      when pxq_m4 = 0 and pxq_m3 > 0 then 1000
      else round(cast(pxq_m3 as numeric)/nullif(cast(pxq_m4 as numeric),0),2)
    end) ratio_pxq_m3
  from `meli-bi-data.SBOX_PF_MKT.pxq_mensal`;


-- ratios de asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_asp3`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_asp3`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when asp_m2 = 0 and asp_m1 = 0 then 0
      when asp_m2 = 0 and asp_m1 > 0 then 1000
      else round(cast(asp_m1 as numeric)/nullif(cast(asp_m2 as numeric),0),2)
    end) ratio_asp_m1,
    (case
      when asp_m3 = 0 and asp_m2 = 0 then 0
      when asp_m3 = 0 and asp_m2 > 0 then 1000
      else round(cast(asp_m2 as numeric)/nullif(cast(asp_m3 as numeric),0),2)
    end) ratio_asp_m2,
    (case
      when asp_m4 = 0 and asp_m3 = 0 then 0
      when asp_m4 = 0 and asp_m3 > 0 then 1000
      else round(cast(asp_m3 as numeric)/nullif(cast(asp_m4 as numeric),0),2)
    end) ratio_asp_m3
  from `meli-bi-data.SBOX_PF_MKT.asp_mensal`;


-- ratios de gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_gmv3`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_gmv3`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when gmv_m2 = 0 and gmv_m1 = 0 then 0
      when gmv_m2 = 0 and gmv_m1 > 0 then 1000
      else round(cast(gmv_m1 as numeric)/nullif(cast(gmv_m2 as numeric),0),2)
    end) ratio_gmv_m1,
    (case
      when gmv_m3 = 0 and gmv_m2 = 0 then 0
      when gmv_m3 = 0 and gmv_m2 > 0 then 1000
      else round(cast(gmv_m2 as numeric)/nullif(cast(gmv_m3 as numeric),0),2)
    end) ratio_gmv_m2,
    (case
      when gmv_m4 = 0 and gmv_m3 = 0 then 0
      when gmv_m4 = 0 and gmv_m3 > 0 then 1000
      else round(cast(gmv_m3 as numeric)/nullif(cast(gmv_m4 as numeric),0),2)
    end) ratio_gmv_m3
  from `meli-bi-data.SBOX_PF_MKT.gmv_mensal`;


-- ratios de parcela consumer electronics
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn3`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn3`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when parcela_hn_m2 = 0 and parcela_hn_m1 = 0 then 0
      when parcela_hn_m2 = 0 and parcela_hn_m1 > 0 then 1000
      else round(cast(parcela_hn_m1 as numeric)/nullif(cast(parcela_hn_m2 as numeric),0),2)
    end) ratio_hn_m1,
    (case
      when parcela_hn_m3 = 0 and parcela_hn_m2 = 0 then 0
      when parcela_hn_m3 = 0 and parcela_hn_m2 > 0 then 1000
      else round(cast(parcela_hn_m2 as numeric)/nullif(cast(parcela_hn_m3 as numeric),0),2)
    end) ratio_hn_m2,
    (case
      when parcela_hn_m4 = 0 and parcela_hn_m3 = 0 then 0
      when parcela_hn_m4 = 0 and parcela_hn_m3 > 0 then 1000
      else round(cast(parcela_hn_m3 as numeric)/nullif(cast(parcela_hn_m4 as numeric),0),2)
    end) ratio_hn_m3
  from `meli-bi-data.SBOX_PF_MKT.parcela_hn_mensal`;


-- ratios de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_adto3`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_adto3`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    (case
      when adto_m2 = 0 and adto_m1 = 0 then 0
      when adto_m2 = 0 and adto_m1 > 0 then 1000
      else round(cast(adto_m1 as numeric)/nullif(cast(adto_m2 as numeric),0),2)
    end) ratio_adto_m1,
    (case
      when adto_m3 = 0 and adto_m2 = 0 then 0
      when adto_m3 = 0 and adto_m2 > 0 then 1000
      else round(cast(adto_m2 as numeric)/nullif(cast(adto_m3 as numeric),0),2)
    end) ratio_adto_m2,
    (case
      when adto_m4 = 0 and adto_m3 = 0 then 0
      when adto_m4 = 0 and adto_m3 > 0 then 1000
      else round(cast(adto_m3 as numeric)/nullif(cast(adto_m4 as numeric),0),2)
    end) ratio_adto_m3
  from `meli-bi-data.SBOX_PF_MKT.adto_mensal`;



------------------------- RATIOS - MES1 X MESES -------------------------

-- ratios de pxq
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_pxq4`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_pxq4`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    pxq_m1 mes_atual,
    (pxq_m2 + pxq_m3 + pxq_m4 + pxq_m5 + pxq_m6) ultimos_meses,
    (case
      when pxq_m1 > 0 and pxq_m2 + pxq_m3 + pxq_m4 + pxq_m5 + pxq_m6 = 0 then 1000
      else round(cast(pxq_m1 as numeric)/nullif(cast((pxq_m2 + pxq_m3 + pxq_m4 + pxq_m5 + pxq_m6)/5 as numeric),0),2)
    end) ratio_pxq_mxmm
  from `meli-bi-data.SBOX_PF_MKT.pxq_mensal`;


-- ratios de asp
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_asp4`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_asp4`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    asp_m1 mes_atual,
    (asp_m2 + asp_m3 + asp_m4 + asp_m5 + asp_m6) ultimos_meses,
    (case
      when asp_m1 > 0 and asp_m2 + asp_m3 + asp_m4 + asp_m5 + asp_m6 = 0 then 1000
      else round(cast(asp_m1 as numeric)/nullif(cast((asp_m2 + asp_m3 + asp_m4 + asp_m5 + asp_m6)/5 as numeric),0),2)
    end) ratio_asp_mxmm
  from `meli-bi-data.SBOX_PF_MKT.asp_mensal`;


-- ratios de gmv
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_gmv4`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_gmv4`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    gmv_m1 mes_atual,
    (gmv_m2 + gmv_m3 + gmv_m4 + gmv_m5 + gmv_m6) ultimos_meses,
    (case
      when gmv_m1 > 0 and gmv_m2 + gmv_m3 + gmv_m4 + gmv_m5 + gmv_m6 = 0 then 1000
      else round(cast(gmv_m1 as numeric)/nullif(cast((gmv_m2 + gmv_m3 + gmv_m4 + gmv_m5 + gmv_m6)/5 as numeric),0),2)
    end) ratio_gmv_mxmm
  from `meli-bi-data.SBOX_PF_MKT.gmv_mensal`;


-- ratios de parcela consumer electronics
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn4`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn4`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    parcela_hn_m1 mes_atual,
    (parcela_hn_m2 + parcela_hn_m3 + parcela_hn_m4 + parcela_hn_m5 + parcela_hn_m6) ultimos_meses,
    (case
      when parcela_hn_m1 > 0 and parcela_hn_m2 + parcela_hn_m3 + parcela_hn_m4 + parcela_hn_m5 + parcela_hn_m6 = 0 then 1000
      else round(cast(parcela_hn_m1 as numeric)/nullif(cast((parcela_hn_m2 + parcela_hn_m3 + parcela_hn_m4 + parcela_hn_m5 + parcela_hn_m6)/5 as numeric),0),2)
    end) ratio_parcela_hn_mxmm
  from `meli-bi-data.SBOX_PF_MKT.parcela_hn_mensal`;


-- ratios de adelantos
drop table if exists `meli-bi-data.SBOX_PF_MKT.ratios_adto4`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ratios_adto4`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    site_id,
    cust_id,
    adto_m1 mes_atual,
    (adto_m2 + adto_m3 + adto_m4 + adto_m5 + adto_m6) ultimos_meses,
    (case
      when adto_m1 > 0 and adto_m2 + adto_m3 + adto_m4 + adto_m5 + adto_m6 = 0 then 1000
      else round(cast(adto_m1 as numeric)/nullif(cast((adto_m2 + adto_m3 + adto_m4 + adto_m5 + adto_m6)/5 as numeric),0),2)
    end) ratio_adto_mxmm
  from `meli-bi-data.SBOX_PF_MKT.adto_mensal`;



------------------------------------ REGRA -----------------------------------

-- junção de ratios
drop table if exists `meli-bi-data.SBOX_PF_MKT.all_ratios`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.all_ratios`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    a.site_id,
    a.cust_id,
    cast(f.semana_atual as numeric) pxq_s_atual,
    cast(coalesce(g.semana_atual) as numeric) asp_s_atual,
    cast(h.semana_atual as numeric) ratio_hn_s_atual,
    cast(j.semana_atual as numeric) gmv_s_atual,
    cast(coalesce(i.semana_atual) as numeric) adto_s_atual,
    cast(p.mes_atual as numeric) pxq_m_atual,
    cast(coalesce(q.mes_atual) as numeric) asp_m_atual,
    cast(r.mes_atual as numeric) ratio_hn_m_atual,
    cast(t.mes_atual as numeric) gmv_m_atual,
    cast(coalesce(s.mes_atual) as numeric) adto_m_atual,

    cast(a.ratio_pxq_s1 as numeric) ratio_pxq_s1,
    cast(f.ratio_pxq_sxss as numeric) ratio_pxq_sxss,
    cast(coalesce(b.ratio_asp_s1) as numeric) ratio_asp_s1,
    cast(coalesce(g.ratio_asp_sxss) as numeric) ratio_asp_sxss,
    cast(c.ratio_hn_s1 as numeric) ratio_hn_s1,
    cast(h.ratio_parcela_hn_sxss as numeric) ratio_parcela_hn_sxss,
    cast(e.ratio_gmv_s1 as numeric) ratio_gmv_s1,
    cast(j.ratio_gmv_sxss as numeric) ratio_gmv_sxss,
    cast(coalesce(d.ratio_adto_s1) as numeric) ratio_adto_s1,
    cast(coalesce(i.ratio_adto_sxss) as numeric) ratio_adto_sxss,

    cast(k.ratio_pxq_m1 as numeric) ratio_pxq_m1,
    cast(p.ratio_pxq_mxmm as numeric) ratio_pxq_mxmm,
    cast(coalesce(l.ratio_asp_m1) as numeric) ratio_asp_m1,
    cast(coalesce(q.ratio_asp_mxmm) as numeric) ratio_asp_mxmm,
    cast(m.ratio_hn_m1 as numeric) ratio_hn_m1,
    cast(r.ratio_parcela_hn_mxmm as numeric) ratio_parcela_hn_mxmm,
    cast(coalesce(o.ratio_gmv_m1) as numeric) ratio_gmv_m1,
    cast(coalesce(t.ratio_gmv_mxmm) as numeric) ratio_gmv_mxmm,
    cast(coalesce(n.ratio_adto_m1) as numeric) ratio_adto_m1,
    cast(coalesce(s.ratio_adto_mxmm) as numeric) ratio_adto_mxmm

  from `meli-bi-data.SBOX_PF_MKT.ratios_pxq1` a
  left join `meli-bi-data.SBOX_PF_MKT.ratios_asp1` b
    on a.cust_id = b.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn1` c
    on a.cust_id = c.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_adto1` d
    on a.cust_id = d.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_gmv1` e
    on a.cust_id = e.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_pxq2` f
    on a.cust_id = f.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_asp2` g
    on a.cust_id = g.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn2` h
    on a.cust_id = h.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_adto2` i
    on a.cust_id = i.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_gmv2` j
    on a.cust_id = j.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_pxq3` k
    on a.cust_id = k.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_asp3` l
    on a.cust_id = l.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn3` m
    on a.cust_id = m.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_adto3` n
    on a.cust_id = n.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_gmv3` o
    on a.cust_id = o.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_pxq4` p
    on a.cust_id = p.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_asp4` q
    on a.cust_id = q.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_parcela_hn4` r
    on a.cust_id = r.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_adto4` s
    on a.cust_id = s.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.ratios_gmv4` t
    on a.cust_id = t.cust_id;



---------------------------- STATUS ----------------------------

-- ev atual
drop table if exists `meli-bi-data.SBOX_PF_MKT.ev_atual`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.ev_atual`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select distinct
    a.cust_id,
    first_value (b.cus_verif_id) over (partition by b.cus_cust_id order by b.changed_dt desc) ev_atual
  from `meli-bi-data.SBOX_PF_MKT.lista_inicial` a
  left join `meli-bi-data.WHOWNER.BT_CUST_VERIFICATIONS` b
    on a.cust_id = b.cus_cust_id;


-- todas as restricoes
drop table if exists `meli-bi-data.SBOX_PF_MKT.all_res`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.all_res`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    a.cust_id,
    b.reason_id,
    b.creation_date,
    dense_rank() over (partition by a.cust_id order by b.creation_date, b.reason_id) as orden
  from `meli-bi-data.SBOX_PF_MKT.lista_inicial` a
  left join `meli-bi-data.WHOWNER.BT_MPR_CUST_RESTRICTION` b
    on a.cust_id = b.cust_id
  where b.status = 'P';


-- res atuais
drop table if exists `meli-bi-data.SBOX_PF_MKT.res_atual`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.res_atual`
OPTIONS (
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
) AS
  select
    a.cust_id,
    concat(max(case when orden = 1 then b.reason_id else '-' end), 
           max(case when orden = 2 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 3 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 4 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 5 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 6 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 7 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 8 then concat(' + ' , b.reason_id) else '' end),
           max(case when orden = 9 then concat(' + ' , b.reason_id) else '' end)) res_atual
    from `meli-bi-data.SBOX_PF_MKT.lista_inicial` a
    left join `meli-bi-data.SBOX_PF_MKT.all_res` b
        on a.cust_id = b.cust_id
    group by a.cust_id;



-------------------------- EXECUÇÃO DA REGRA --------------------------

-- tabla de scoring para subir las infos
drop table if exists `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza`;
CREATE TABLE `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza`
  (
  insert_date date,
  site_id string(80),
  cust_id int,
  ev_hoy string(80),
  restr_hoy string(80),
  pxq_s_atual numeric,
  asp_s_atual numeric,
  parcela_hn_s_atual numeric,
  gmv_s_atual numeric,
  adto_s_atual numeric,
  pxq_m_atual numeric,
  asp_m_atual numeric,
  parcela_hn_m_atual numeric,
  gmv_m_atual numeric,
  adto_m_atual numeric,
  ratio_pxq_s1 numeric,
  ratio_pxq_sxss numeric,
  ratio_asp_s1 numeric,
  ratio_asp_sxss numeric,
  ratio_parcela_hn_s1 numeric,
  ratio_parcela_hn_sxss numeric,
  ratio_gmv_s1 numeric,
  ratiogmv_sxss numeric,
  ratio_adto_s1 numeric,
  ratio_adto_sxss numeric,
  ratio_pxq_m1 numeric,
  ratio_pxq_mxmm numeric,
  ratio_asp_m1 numeric,
  ratio_asp_mxmm numeric,
  ratio_parcela_hn_m1 numeric,
  ratio_parcela_hn_mxmm numeric,
  ratio_gmv_m1 numeric,
  ratio_gmv_mxmm numeric,
  ratio_adto_m1 numeric,
  ratio_adto_mxmm numeric
  );


-- insertar dados na tabela
insert into `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza`
 (insert_date,  site_id, cust_id,  ev_hoy, restr_hoy,  pxq_s_atual, asp_s_atual,  parcela_hn_s_atual,  gmv_s_atual,  adto_s_atual,
  pxq_m_atual,  asp_m_atual,  parcela_hn_m_atual,  gmv_m_atual,  adto_m_atual,  ratio_pxq_s1,  ratio_pxq_sxss,
  ratio_asp_s1,  ratio_asp_sxss,  ratio_parcela_hn_s1,  ratio_parcela_hn_sxss,  ratio_gmv_s1,  ratiogmv_sxss,
  ratio_adto_s1,  ratio_adto_sxss,  ratio_pxq_m1,  ratio_pxq_mxmm,  ratio_asp_m1,  ratio_asp_mxmm,  ratio_parcela_hn_m1,
  ratio_parcela_hn_mxmm,  ratio_gmv_m1,  ratio_gmv_mxmm,  ratio_adto_m1,  ratio_adto_mxmm)
  select distinct
    current_date,
    a.site_id,
    a.cust_id,
    (case when b.ev_atual is null then 'DM' else b.ev_atual end) ev_atual,
    c.res_atual,
    a.pxq_s_atual,
    a.asp_s_atual,
    a.ratio_hn_s_atual,
    a.gmv_s_atual,
    a.adto_s_atual,
    a.pxq_m_atual,
    a.asp_m_atual,
    a.ratio_hn_m_atual,
    a.gmv_m_atual,
    a.adto_m_atual,
    a.ratio_pxq_s1,
    a.ratio_pxq_sxss,
    a.ratio_asp_s1,
    a.ratio_asp_sxss,
    a.ratio_hn_s1,
    a.ratio_parcela_hn_sxss,
    a.ratio_gmv_s1,
    a.ratio_gmv_sxss,
    a.ratio_adto_s1,
    a.ratio_adto_sxss,
    a.ratio_pxq_m1,
    a.ratio_pxq_mxmm,
    a.ratio_asp_m1,
    a.ratio_asp_mxmm,
    a.ratio_hn_m1,
    a.ratio_parcela_hn_mxmm,
    a.ratio_gmv_m1,
    a.ratio_gmv_mxmm,
    a.ratio_adto_m1,
    a.ratio_adto_mxmm
  from `meli-bi-data.SBOX_PF_MKT.all_ratios` a
  left join `meli-bi-data.SBOX_PF_MKT.ev_atual` b
    on a.cust_id = b.cust_id
  left join `meli-bi-data.SBOX_PF_MKT.res_atual` c
    on a.cust_id = c.cust_id
  where (coalesce(ratio_pxq_sxss,0) + coalesce(ratio_pxq_mxmm,0) + coalesce(ratio_pxq_s1,0) + coalesce(ratio_pxq_m1,0) > 25
    and coalesce(ratio_asp_sxss,0) + coalesce(ratio_asp_mxmm,0) + coalesce(ratio_asp_s1,0) + coalesce(ratio_asp_m1,0) > 3.33
    and coalesce(ratio_gmv_sxss,0) + coalesce(ratio_gmv_mxmm,0) + coalesce(ratio_gmv_s1,0) + coalesce(ratio_gmv_m1,0) > 7.5
    and coalesce(ratio_hn_s_atual) > 0.1)
      or
    (coalesce(ratio_pxq_sxss,0) + coalesce(ratio_pxq_mxmm,0) + coalesce(ratio_pxq_s1,0) + coalesce(ratio_pxq_m1,0) > 25
    and coalesce(ratio_gmv_sxss,0) + coalesce(ratio_gmv_mxmm,0) + coalesce(ratio_gmv_s1,0) + coalesce(ratio_gmv_m1,0) > 7.5
    and coalesce(ratio_hn_s_atual,0) > 0.1)
    and not exists (select *
                    from `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza` aa
                    where aa.cust_id = a.cust_id
                      and aa.insert_date >= current_date - 60);



--------------------------- SELEÇÃO DE DADOS ---------------------------

-- DDL dos dados
select * from `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza` order by 1 desc, 6 desc;

delete from `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza` where insert_date = current_date;

UPDATE `meli-bi-data.SBOX_PF_MKT.marca_bof_amenaza`
  SET site_id = 'XXX'
  WHERE insert_date = current_date;




